<!DOCTYPE html>
<html>
<head>
<meta charset="ISO-8859-1">
<title>Insert title here</title>
<script type="text/javascript" src="js/jquery-3.2.1.min.js"></script>
<script type="text/javascript" src="js/jquery.soap.js"></script>
<script type="text/javascript" src="js/jquery.format.js"></script>
</head>
<body>
	<h1>Test Canvas</h1>
	<canvas id="game" width="640" height="480"></canvas>
	<br />
	<input type="button" onclick="getLista();" value="Click" /><input id="idCliente" type="text" readonly="readonly" />
	<br />
	<pre><code id="output"></code></pre>
	<script type="text/javascript">
	
		lOtrosUsuarios = [];
	
		// Colores
		cCentro = getColorRandom();
		cBorde = getColorRandom();

		// Valores cuadrado
		pt = 40;	// Tamannio
		ph = 40;

		p1x = 0;	// Posicion
		p1y = 0;

		vx = 0;		// Velocidad
		vy = 0;
		
		id_elemento = valorRandom();
		
		window.onload = function() {
			c = document.getElementById("game");
			cc = c.getContext("2d");
			document.addEventListener("keydown", keyPush);
			posicionInicio();
			setInterval(update, 1000 / 30);
			setInterval(soapRequest, 1000/30);		
			setInterval(getLista, 1000/30);
		}

		function update() {
			cc.fillStyle = "black";
			cc.fillRect(0, 0, c.width, c.height);

			crearCirculo(p1x, p1y, cCentro, cBorde);
			
			for(i = 0; i < lOtrosUsuarios.length; i++){
				var p = lOtrosUsuarios[i];
				crearCirculo(p.ejeX, p.ejeY, p.colorCentro, p.colorBorde);
			}
			
			mover();
		}
		
		function posicionInicio() {
			p1x = c.width / 2;	// Posicion
			p1y = c.height / 2;	
		}
		
		function crearRectangulo(){
			cc.fillStyle = "green";
			cc.fillRect(p1x, p1y, pt, ph);
		}
		
		function crearCirculo(x, y, color, colorBorde){
			radius = 20;
			
			cc.beginPath();
			cc.arc(x, y, radius, 0, 2 * Math.PI, false);
			cc.fillStyle = color;
			cc.fill();
			cc.lineWidth = 5;
			cc.strokeStyle = colorBorde;
			cc.stroke();
		}
		
		function mover(){
			p1x += vx;
			p1y += vy;
			
			if (p1x < 0) { p1x = c.width; }
			if (p1x > c.width) { p1x = 0; }
			if (p1y < 0) { p1y = c.height; }
			if (p1y > c.height) { p1y = 0; }
		}
		
		function keyPush(evt){
			
			vContante = 4;
			
			switch (evt.keyCode) {
			case 37:	// Izq
				vx = -vContante; vy = 0;
				break;
			case 38:	// 
				vx = 0; vy = -vContante; 
				break;
			case 39:
				vx = vContante; vy = 0;
				break;
			case 40:
				vx = 0; vy = vContante;
				break;			
			default:
				vx =  0; vy = 0;
				break;
			}		
		}
		
		
		// Color HTML
		function getColorRandom(){
			var r = Math.floor((Math.random() * 255) + 1);
			var g = Math.floor((Math.random() * 255) + 1);
			var b = Math.floor((Math.random() * 255) + 1);
			
			return "#" + componentToHex(r) + componentToHex(g) + componentToHex(b);
		}
		
		function componentToHex(c) {
		    var hex = c.toString(16);
		    return hex.length == 1 ? "0" + hex : hex;
		}
		
		// ID
		function valorRandom(){
			var num = Math.floor((Math.random() * 100) + 1);
			document.getElementById("idCliente").value = num;
			return num;
		}
		
	// Llamadas SOAP
	
	function soapRequest(){	
		$.soap({
			url: "http://localhost:8080/TestCanvas/services/ImplMovimiento?wsdl",
			method: "actualizarMovimiento",
			data: {ID: id_elemento, colorCentro: cCentro, colorBorde: cBorde, ejeX: p1x, ejeY: p1y},
			HTTPHeaders:{
				'Content-Type': 'application/xml',
				'Server-Protocol': 'SOAP'
			},
			success: function(response){
				//response = $.format(response.toString(),{ method: 'xml'});
				//$("#output").text(response);
			},
			error: function(data, status, req) {
		        //alert('err'+data.state);
			}
		});
	}
	
	function getLista(){
		$.soap({
			url: "http://localhost:8080/TestCanvas/services/ImplMovimiento?wsdl",
			method: "getListaPosiciones",
			data: {},
			HTTPHeaders:{
				'Content-Type': 'application/xml',
				'Server-Protocol': 'SOAP'
			},
			success: function(response){
				var txt_output = $.format(response.toString(),{ method: 'xml'});
				$("#output").text(txt_output);
				
				var lPosiciones = response.content.getElementsByTagName("getListaPosicionesResponse");
				var lPosiciones = lPosiciones[0].children;
				
				lOtrosUsuarios = [];
				
				for (i=1; i <= lPosiciones.length; i++){
					var _ID = lPosiciones[i - 1].getElementsByTagName("ns" + i + ":ID")[0].innerHTML;
					var _colorBorde = lPosiciones[i - 1].getElementsByTagName("ns" + i + ":colorBorde")[0].innerHTML;
					var _colorCentro = lPosiciones[i - 1].getElementsByTagName("ns" + i + ":colorCentro")[0].innerHTML;
					var _ejeX = lPosiciones[i - 1].getElementsByTagName("ns" + i + ":ejeX")[0].innerHTML;
					var _ejeY = lPosiciones[i - 1].getElementsByTagName("ns" + i + ":ejeY")[0].innerHTML;
					
					if (_ID != id_elemento) {
						var pos = {ID: _ID, 
								colorBorde: _colorBorde,
								colorCentro: _colorCentro,
								ejeX: _ejeX,
								ejeY: _ejeY};
						lOtrosUsuarios.push(pos);
					}					
				}
								
			},
			error: function(data, status, req) {
		        //alert('err'+data.state);
				if(true){}
			}
		});
	}
	
	
	
	</script>				
</body>
</html>